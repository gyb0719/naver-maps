<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheets 백업 테스트</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover { background: #3367d6; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
        pre {
            background: #f1f1f1;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 Google Sheets 백업 시스템 테스트</h1>
        
        <div id="authStatus" class="status info">
            📡 Google API 로딩 중...
        </div>
        
        <div class="result">
            <h3>테스트 단계:</h3>
            <ol>
                <li><strong>Google 로그인</strong> - OAuth 인증 테스트</li>
                <li><strong>API 권한 확인</strong> - Sheets API 접근 권한</li>
                <li><strong>테스트 백업 실행</strong> - 샘플 데이터로 스프레드시트 생성</li>
                <li><strong>DataManager 통합</strong> - 자동 백업 시스템 연동</li>
            </ol>
        </div>
        
        <div>
            <button id="loginBtn" onclick="testLogin()" disabled>1️⃣ Google 로그인 테스트</button>
            <button id="apiBtn" onclick="testAPI()" disabled>2️⃣ API 권한 확인</button>
            <button id="backupBtn" onclick="testBackup()" disabled>3️⃣ 테스트 백업 실행</button>
            <button id="autoBtn" onclick="testAutoBackup()" disabled>4️⃣ 자동 백업 테스트</button>
        </div>
        
        <div style="margin-top: 15px;">
            <button onclick="location.reload()" style="background: #28a745;">🔄 페이지 새로고침</button>
            <button onclick="retryInitialization()" style="background: #ffc107; color: black;">⚡ API 재초기화</button>
            <button onclick="showDebugInfo()" style="background: #6c757d;">🔍 디버그 정보</button>
        </div>
        
        <div id="results"></div>
    </div>
    
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <script>
        let gapi;
        let tokenClient;
        let accessToken = null;
        
        const CLIENT_ID = '506368463001-um0b25os2vlep7mumonf63pcm9c9a0n3.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file';
        
        // 페이지 로드시 초기화
        window.addEventListener('load', async () => {
            await loadGoogleAPI();
            initializeAuth();
        });
        
        async function loadGoogleAPI() {
            try {
                updateStatus('🔄 Google API 스크립트 로딩 중...', 'info');
                
                // Google API 스크립트 로드
                if (!window.gapi) {
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = 'https://apis.google.com/js/api.js';
                        script.onload = () => {
                            console.log('✅ Google API 스크립트 로드됨');
                            resolve();
                        };
                        script.onerror = (error) => {
                            console.error('❌ Google API 스크립트 로드 실패:', error);
                            reject(new Error('Google API 스크립트 로드 실패'));
                        };
                        document.head.appendChild(script);
                    });
                }
                
                // gapi 객체가 사용 가능할 때까지 대기
                await new Promise((resolve, reject) => {
                    let attempts = 0;
                    const checkGapi = () => {
                        attempts++;
                        console.log(`GAPI 확인 시도 ${attempts}/50`);
                        
                        if (window.gapi && typeof window.gapi.load === 'function') {
                            console.log('✅ GAPI 객체 사용 가능');
                            resolve();
                        } else if (attempts >= 50) {
                            reject(new Error('GAPI 객체 로딩 타임아웃'));
                        } else {
                            setTimeout(checkGapi, 100);
                        }
                    };
                    checkGapi();
                });
                
                updateStatus('🔄 Google API 클라이언트 초기화 중...', 'info');
                
                // GAPI 클라이언트 로드
                await new Promise((resolve, reject) => {
                    try {
                        gapi.load('client', {
                            callback: () => {
                                console.log('✅ GAPI 클라이언트 로드됨');
                                resolve();
                            },
                            onerror: (error) => {
                                console.error('❌ GAPI 클라이언트 로드 실패:', error);
                                reject(new Error('GAPI 클라이언트 로드 실패'));
                            }
                        });
                    } catch (error) {
                        reject(error);
                    }
                });
                
                // Google Sheets API 초기화
                await gapi.client.init({
                    discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
                });
                
                console.log('✅ Google Sheets API 초기화 완료');
                updateStatus('✅ Google API 로딩 완료', 'success');
                document.getElementById('loginBtn').disabled = false;
                
            } catch (error) {
                console.error('❌ Google API 로딩 전체 실패:', error);
                updateStatus(`❌ Google API 로딩 실패: ${error.message}`, 'error');
                addResult(`🔍 해결방법: 페이지를 새로고침하거나 브라우저 캐시를 정리해보세요.`);
            }
        }
        
        function initializeAuth() {
            try {
                // Google Identity Services 사용 가능 확인
                if (!window.google || !window.google.accounts) {
                    updateStatus('⚠️ Google Identity Services 로딩 중... 잠시만 기다려주세요', 'info');
                    
                    // 3초 후 다시 시도
                    setTimeout(() => {
                        if (window.google && window.google.accounts) {
                            initializeAuth();
                        } else {
                            updateStatus('❌ Google Identity Services 로드 실패', 'error');
                            addResult('🔄 페이지를 새로고침하여 다시 시도해주세요');
                        }
                    }, 3000);
                    return;
                }
                
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: (response) => {
                        if (response.error) {
                            updateStatus(`❌ 로그인 오류: ${response.error}`, 'error');
                            return;
                        }
                        
                        if (response.access_token) {
                            accessToken = response.access_token;
                            gapi.client.setToken({ access_token: accessToken });
                            updateStatus('✅ Google 로그인 성공!', 'success');
                            document.getElementById('apiBtn').disabled = false;
                            addResult('🔐 인증 토큰 획득 완료');
                        }
                    },
                    error_callback: (error) => {
                        updateStatus(`❌ 인증 초기화 오류: ${error}`, 'error');
                    }
                });
                
                console.log('✅ Google 인증 클라이언트 초기화 완료');
                
            } catch (error) {
                console.error('❌ 인증 초기화 실패:', error);
                updateStatus(`❌ 인증 초기화 실패: ${error.message}`, 'error');
            }
        }
        
        async function testLogin() {
            try {
                updateStatus('🔄 Google 로그인 진행 중...', 'info');
                tokenClient.requestAccessToken();
            } catch (error) {
                updateStatus(`❌ 로그인 실패: ${error.message}`, 'error');
            }
        }
        
        async function testAPI() {
            if (!accessToken) {
                updateStatus('❌ 먼저 로그인해주세요', 'error');
                return;
            }
            
            try {
                updateStatus('🔄 API 권한 확인 중...', 'info');
                
                // 간단한 API 호출로 권한 테스트
                const response = await fetch('https://www.googleapis.com/drive/v3/about?fields=user', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const userData = await response.json();
                    updateStatus('✅ API 권한 확인 완료', 'success');
                    addResult(`👤 사용자: ${userData.user.displayName} (${userData.user.emailAddress})`);
                    document.getElementById('backupBtn').disabled = false;
                } else {
                    throw new Error(`API 호출 실패: ${response.status}`);
                }
                
            } catch (error) {
                updateStatus(`❌ API 권한 확인 실패: ${error.message}`, 'error');
            }
        }
        
        async function testBackup() {
            if (!accessToken) {
                updateStatus('❌ 먼저 로그인해주세요', 'error');
                return;
            }
            
            try {
                updateStatus('🔄 테스트 백업 실행 중...', 'info');
                
                // 테스트 스프레드시트 생성
                const createResponse = await gapi.client.sheets.spreadsheets.create({
                    properties: {
                        title: `네이버지도 필지관리 테스트 백업 ${new Date().toLocaleString()}`
                    }
                });
                
                const spreadsheetId = createResponse.result.spreadsheetId;
                addResult(`📊 스프레드시트 생성: ${spreadsheetId}`);
                
                // 테스트 데이터 추가
                const testData = [
                    ['지번', '소유자이름', '소유자주소', '연락처', '메모', '색상', '등록시간'],
                    ['123-4', '홍길동', '서울시 강남구 테헤란로 123', '010-1234-5678', '테스트 필지 1', '빨강', new Date().toLocaleString()],
                    ['456-7', '김철수', '서울시 서초구 반포대로 456', '010-9876-5432', '테스트 필지 2', '파랑', new Date().toLocaleString()],
                    ['789-0', '이영희', '서울시 종로구 종로 789', '010-1111-2222', '테스트 필지 3', '노랑', new Date().toLocaleString()]
                ];
                
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: spreadsheetId,
                    range: 'A1',
                    valueInputOption: 'RAW',
                    resource: {
                        values: testData
                    }
                });
                
                updateStatus('✅ 테스트 백업 성공!', 'success');
                addResult(`🎉 테스트 데이터 ${testData.length - 1}개 행 저장 완료`);
                addResult(`🔗 스프레드시트 URL: https://docs.google.com/spreadsheets/d/${spreadsheetId}`);
                
                document.getElementById('autoBtn').disabled = false;
                
            } catch (error) {
                updateStatus(`❌ 테스트 백업 실패: ${error.message}`, 'error');
                addResult(`에러 상세: ${JSON.stringify(error, null, 2)}`);
            }
        }
        
        async function testAutoBackup() {
            try {
                updateStatus('🔄 DataManager 자동 백업 테스트...', 'info');
                
                // 실제 DataManager와 연동
                if (window.dataManager) {
                    const result = await window.dataManager.manualGoogleBackup();
                    updateStatus('✅ 자동 백업 시스템 연동 성공!', 'success');
                    addResult(`📈 DataManager 백업 결과: ${JSON.stringify(result, null, 2)}`);
                } else {
                    // 메인 페이지로 이동하여 실제 테스트
                    updateStatus('📍 메인 앱으로 이동하여 실제 데이터로 테스트하세요', 'info');
                    addResult('🔗 메인 앱: <a href="/">http://localhost:5000</a>');
                    addResult('💡 메인 앱에서 필지 추가 후 "구글 시트 전송" 버튼으로 테스트');
                }
                
            } catch (error) {
                updateStatus(`❌ 자동 백업 테스트 실패: ${error.message}`, 'error');
            }
        }
        
        function updateStatus(message, type) {
            const statusEl = document.getElementById('authStatus');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        function addResult(message) {
            const resultsEl = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'result';
            resultDiv.innerHTML = message;
            resultsEl.appendChild(resultDiv);
        }
        
        // 재초기화 함수
        async function retryInitialization() {
            try {
                updateStatus('🔄 API 재초기화 시작...', 'info');
                
                // 기존 상태 리셋
                accessToken = null;
                tokenClient = null;
                
                // 버튼들 비활성화
                ['loginBtn', 'apiBtn', 'backupBtn', 'autoBtn'].forEach(id => {
                    document.getElementById(id).disabled = true;
                });
                
                // 다시 초기화
                await loadGoogleAPI();
                initializeAuth();
                
                addResult('🔄 재초기화 완료');
                
            } catch (error) {
                updateStatus(`❌ 재초기화 실패: ${error.message}`, 'error');
            }
        }
        
        // 디버그 정보 표시
        function showDebugInfo() {
            const debugInfo = {
                'Google API (gapi)': typeof window.gapi !== 'undefined' ? '✅ 로드됨' : '❌ 없음',
                'Google Identity (google.accounts)': (window.google && window.google.accounts) ? '✅ 로드됨' : '❌ 없음',
                'GAPI Client': (window.gapi && window.gapi.client) ? '✅ 초기화됨' : '❌ 없음',
                'Access Token': accessToken ? '✅ 있음' : '❌ 없음',
                'Token Client': tokenClient ? '✅ 초기화됨' : '❌ 없음',
                'CLIENT_ID': CLIENT_ID || '❌ 없음',
                '현재 URL': window.location.href,
                '브라우저': navigator.userAgent.split(' ').slice(-2).join(' ')
            };
            
            let debugText = '<h4>🔍 디버그 정보:</h4><pre>';
            Object.entries(debugInfo).forEach(([key, value]) => {
                debugText += `${key}: ${value}\n`;
            });
            debugText += '</pre>';
            
            // 네트워크 연결 테스트
            debugText += '<h4>🌐 네트워크 테스트:</h4>';
            
            addResult(debugText);
            
            // Google API 서버 연결 테스트
            testNetworkConnection();
        }
        
        // 네트워크 연결 테스트
        async function testNetworkConnection() {
            const testUrls = [
                'https://accounts.google.com/gsi/client',
                'https://apis.google.com/js/api.js',
                'https://sheets.googleapis.com/$discovery/rest?version=v4'
            ];
            
            addResult('🔄 네트워크 연결 테스트 중...');
            
            for (const url of testUrls) {
                try {
                    const response = await fetch(url, { method: 'HEAD', mode: 'no-cors' });
                    addResult(`✅ ${url} - 연결 성공`);
                } catch (error) {
                    addResult(`❌ ${url} - 연결 실패: ${error.message}`);
                }
            }
        }
    </script>
</body>
</html>